# Severe Weather Analysis - harmful event types

## Synopsis
This investigation explores the storm data from the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm data base. Based on the data bases estimates of fatalities, injuries, crop and property damage we find the most harmful event types. The relative harmfulness of an event type being determined by the total damage caused by it. 

Due to changes over time in the way the data in the data base has been collected only data newer than 1996 is used in the investigation.

The investigation finds that the most harmful events with respect to population health are "heat" and "tornado" with respect to both fatalities and injuries. With respect to crop and property damage the most harmful event types are "drought", "flood" and "hurricane".

## Data Processing

### Initialise packages

```{r initialization, echo=TRUE}
library(stringr)
library(knitr)
library(ggplot2)
library(gridExtra)

```

### Download data

```{r download, echo=TRUE}
data.dir = "./data"
zip.filename = file.path(data.dir, "StormData.csv.bz2")
url <- 'https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2'

if(!file.exists(zip.filename)) {
    dir.create(data.dir)
    download.file(url, zip.filename, method="curl")
}

```

### Read data

```{r read, echo=TRUE, cache=TRUE}
# Note: the assignment is inconsistent on whether analysis should start from the csv file or from the csv.bz2 file. I have chosen the later.
storm.data <- read.csv(bzfile(zip.filename), 
                       colClasses=c("EVTYPE"="character", 
                                    "PROPDMGEXP"="character", 
                                    "CROPDMGEXP"="character"))
```

### Filtering
This analysis will address questions regarding population health and economic consequences. Therefore it is reasonable to only consider events where there was recorded either fatalities, injuries, property damage or crop damage or any combination of these. As a result the data is filtered based on these criteria.

```{r filter, echo=TRUE}
storm.data.filtered <- storm.data[storm.data$FATALITIES > 0 | 
                                      storm.data$INJURIES > 0 | 
                                      storm.data$PROPDMG > 0 | 
                                      storm.data$CROPDMG > 0, ]

```

This filtering brings the number of recorded events down from **`r dim(storm.data)[1]`** to **`r dim(storm.data.filtered)[1]`**. Also it reduces the number of unique event types from **`r length(unique(storm.data$EVTYPE))`** to **`r length(unique(storm.data.filtered$EVTYPE))`**.

### Cleanup and enrichment
Even with the above data reduction the number of event types is still excessive. This is largely due to casing, spelling errors, different words for the same event etc. The following section attempts to partially clean up this column a bit. Only event types with a significant number of entries and where the change is obvious are handled.

Furthermore, according to the [description of the data](http://www.ncdc.noaa.gov/stormevents/details.jsp "NOAA Storm Events Database description") prior to 1996 only Tornados, Thunderstorms and Hail were reported. This would seem to cause an overrepresentation of these event types and skew the results. Therefore only events occuring after 1/1/1996 are included in the analysis.

```{r cleanup, echo=TRUE}
# Add a column with a proper date 
storm.data.filtered$BEGIN.DATE <- as.Date(storm.data.filtered$BGN_DATE, format="%m/%d/%Y")

# Filter out data before 1/1/1996
storm.data.filtered <- storm.data.filtered[storm.data.filtered$BEGIN.DATE>=as.Date('1/1/1996', format="%m/%d/%Y"), ]

# Clean up event type names
event.type <- storm.data.filtered$EVTYPE # Get the EVTYPE's

event.type <- tolower(event.type)
event.type <- str_trim(event.type)
event.type <- gsub('.*tstm.*|.*thunderstorm.*', 'thunderstorm', event.type)
event.type <- gsub('.*high wind.*', 'high wind', event.type)
event.type <- gsub('.*tornado.*', 'tornado', event.type)
event.type <- gsub('.*hail.*', 'hail', event.type)
event.type <- gsub('.*flash flood.*', 'flash flood', event.type)
event.type <- gsub('.*heat.*', 'heat', event.type)
event.type <- gsub('.*tropical storm.*', 'tropical storm', event.type)
event.type <- gsub('.*hurricane.*', 'hurricane', event.type)
event.type <- gsub('.*rip current.*', 'rip current', event.type)
storm.data.filtered$EVTYPE <- event.type # Set the fixed EVTYPE's back

# Calculating the property and crop damage from the CROPDMG, CROPDMGEXP, PROPDMG and PROPDMGEXP columns. The calculation is 
# based on mappings found on page 12 in this PDF: http://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf
# 0 -> 1
# K -> 1000
# M -> 1000000
# B -> 1000000000
exp.ref <- c("0" = 1, "K" = 1000, "M" = 1E6, "B" = 1E9)

# Set all expononts with no value to 0
clean.cropdmg.exp<-gsub('^$', 0, storm.data.filtered$CROPDMGEXP)
clean.propdmg.exp<-gsub('^$', 0, storm.data.filtered$PROPDMGEXP)

storm.data.filtered$CROP.DAMAGE <-
  unname(storm.data.filtered$CROPDMG * exp.ref[clean.cropdmg.exp])

storm.data.filtered$PROPERTY.DAMAGE <-
  unname(storm.data.filtered$PROPDMG * exp.ref[clean.propdmg.exp])

#Just to avoid a magic number in the following
countToShow <- 10
```

The result of the above cleanup is that the data now contains **`r length(unique(storm.data.filtered$EVTYPE))`** unique event types. The `r countToShow` most recorded event types are listed in the below table: 

```{r count_types, echo=TRUE, results='asis'}
types.rle <- rle(storm.data.filtered$EVTYPE[(order(storm.data.filtered$EVTYPE))])

reported.event.counts <- data.frame(EVTYPE = types.rle$values[order(types.rle$length, decreasing = TRUE)], 
                                    COUNT = types.rle$length[order(types.rle$length, decreasing = TRUE)])

kable(head(reported.event.counts[,1:2], n=countToShow), format="markdown")

```

These `r countToShow` event types account for **`r sum(reported.event.counts[1:countToShow,2])`** events corresponding to **`r sum(reported.event.counts[1:countToShow,2])/dim(storm.data.filtered)[1]*100`%** of the filtered data. Further investigations of the event types could reduce the number of types further but it does not seem necessary for the analysis.

## Results
Aggregate the data to find the most severe event types.
```{r aggregate_and_sort, echo=TRUE}
fatalities.sum.per.evtype <- aggregate(FATALITIES~EVTYPE, data=storm.data.filtered, sum)
fatalities.sum.per.evtype <- fatalities.sum.per.evtype[order(fatalities.sum.per.evtype$FATALITIES, decreasing = TRUE), ]

injuries.sum.per.evtype <- aggregate(INJURIES~EVTYPE, data=storm.data.filtered, sum)
injuries.sum.per.evtype <- injuries.sum.per.evtype[order(injuries.sum.per.evtype$INJURIES, decreasing = TRUE), ]

propdmg.sum.per.evtype <- aggregate(PROPERTY.DAMAGE~EVTYPE, data=storm.data.filtered, sum)
propdmg.sum.per.evtype <- propdmg.sum.per.evtype[order(propdmg.sum.per.evtype$PROPERTY.DAMAGE, decreasing = TRUE), ]

cropdmg.sum.per.evtype <- aggregate(CROP.DAMAGE~EVTYPE, data=storm.data.filtered, sum)
cropdmg.sum.per.evtype <- cropdmg.sum.per.evtype[order(cropdmg.sum.per.evtype$CROP.DAMAGE, decreasing = TRUE), ]
```

### Population health

XXX: need to make it more clear that it is one figure with two plots
```{r ten_most_health_consequences, echo=TRUE,fig.align='center', fig.scap='Highest health risk events since 1996'}
p1 <- ggplot(data=fatalities.sum.per.evtype[1:10,], 
    aes(x=reorder(EVTYPE, order(FATALITIES)),
        y=FATALITIES)) + 
    geom_bar(fill="#DD8888", stat="identity") +
    xlab(NULL) +
    ylab("Total fatalities") +
    coord_flip()

p2 <- ggplot(data=injuries.sum.per.evtype[1:10,], 
    aes(x=reorder(EVTYPE, order(INJURIES)),
        y=INJURIES)) + 
    geom_bar(fill="#DD8888", stat="identity") +
    xlab(NULL) +
    ylab("Total injuries") +
    coord_flip()

grid.arrange(p1,p2)
```

### Economic consequeces
XXX: need to make it more clear that it is one figure with two plots
```{r ten_most_economic_consequence, echo=TRUE,fig.align='center', fig.scap='Highest economic consequence events since 1996'}
p1 <- ggplot(data=cropdmg.sum.per.evtype[1:10,], 
    aes(x=reorder(EVTYPE, order(CROP.DAMAGE)),
        y=CROP.DAMAGE)) + 
    geom_bar(fill="#DD8888", stat="identity") +
    xlab(NULL) +
    ylab("Crop damage (US $)") +
    coord_flip()

p2 <- ggplot(data=propdmg.sum.per.evtype[1:10,], 
    aes(x=reorder(EVTYPE, order(PROPERTY.DAMAGE)),
        y=PROPERTY.DAMAGE)) + 
    geom_bar(fill="#DD8888", stat="identity") +
    xlab(NULL) +
    ylab("Property damage (US $)") +
    coord_flip()

grid.arrange(p1,p2)
```
